package com.isinonet

import java.util

import com.huaban.analysis.jieba.{JiebaSegmenter, SegToken}
import com.huaban.analysis.jieba.JiebaSegmenter.SegMode
import org.apache.spark.ml.classification.NaiveBayes
import org.apache.spark.ml.evaluation.MulticlassClassificationEvaluator
import org.apache.spark.ml.feature.{HashingTF, IDF, LabeledPoint}
import org.apache.spark.ml.linalg.Vector
import org.apache.spark.sql.{Row, SparkSession}
import org.apache.spark.sql.functions._

object IBMseniment {
  def main(a:Array[String]): Unit= {
    val sparkSession = SparkSession.builder()
    .appName("IBMseniment")
        .config("spark.testing.memory", 1024*1024*1024)
        .config("spark.default.parallelism", 10)
        .config("spark.sql.shuffle.partitions", 10)
    .master("local")
    .getOrCreate()
    import sparkSession.implicits._
    //scala  转为java 的集合
    //    import scala.collection.JavaConversions._
    import scala.collection.JavaConversions._

    val commentsText = sparkSession.read.textFile("data/douban_comment.txt")

    // 停用词
    val stopWords = sparkSession.read.textFile("data/stopwords.txt").collectAsList().mkString(",")

    val broadStop = sparkSession.sparkContext.broadcast(stopWords)
    // 数据预处理
    val rateDocument = commentsText.map(line => {
      line.split("\t")
    }).filter(_.length >= 2)
      .map(line => (line(0), line(1))).toDF("rate", "comment")
    // 统计数据基本信息
      // +----+-----------+
      // |rate|count(rate)|
      // +----+-----------+
      // |4   |5920       |
      // |3   |7100       |
      // |5   |8140       |
      // +----+-----------+
//    val fiveRateDocument = rateDocument.groupBy($"rate").agg(count("rate")).show(false)
    // 打五分是好评, 三分及三分以下的是坏评
    // 合并负样本数据
    val allRateDocument = rateDocument.filter("rate > 0")

    val rate = allRateDocument.select(when($"rate" >=5, 0).when($"rate" === 4, 1).otherwise(2).as("rate")).rdd
    val comments = allRateDocument.select($"comment").rdd
    // 分词
    val words = comments.mapPartitions(it => {
      val jiebaSegmenter = new JiebaSegmenter()
      val stopWordsStr = broadStop.value
      it.map(comment => {
        val segTokens = jiebaSegmenter.process(comment.getAs[String]("comment"), SegMode.SEARCH).toArray
          .map(token => token.asInstanceOf[SegToken].word).filter(stopWordsStr.indexOf(_) < 0)
        segTokens
      })
    }).toDF("word")
//    words.take(10).map((_(0))).foreach(println)

    val hashingTF = new HashingTF().setInputCol("word")
      .setOutputCol("rawFeatures")
    hashingTF.write.overwrite().save("hdfs://192.168.1.200:9000/hashingTF")

    val tf = hashingTF.transform(words)
    tf.cache()

    val idf = new IDF().setInputCol("rawFeatures")
      .setOutputCol("features")
    // 训练
    val iDFModel = idf.fit(tf)
    iDFModel.write.overwrite().save("hdfs://192.168.1.200:9000/iDFModel")
    // 计算 TF-IDF 矩阵
    val tfidf = iDFModel.transform(tf).select($"features")

//    +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
//    |features                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
//    +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
//    |(262144,[3402,5224,11700,23411,24190,25171,29811,44436,47909,84318,85364,99516,115310,116958,117468,129826,158439,163110,175101,182711,188230,191490,200082,219629,227525,238030,248087,248533],[1.9739891727509844,0.47234018733735444,3.0237438185897627,1.9739891727509844,3.0237438185897627,1.9739891727509844,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,0.9758281344463394,5.333328196568886,3.0237438185897627,5.333328196568886,0.6702501205762497,3.0237438185897627,2.666664098284443,2.666664098284443,3.0237438185897627,3.0237438185897627,2.1367582099353166,2.6008869677697293,3.0237438185897627,1.4732281990790177,3.0237438185897627,0.39828181604552887,3.0237438185897627,3.0237438185897627])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
//    |(262144,[5224,7764,8306,18369,26081,28500,34967,36657,37868,44403,47672,63487,64028,64720,66345,75379,80738,85364,92269,94244,95360,95913,101791,102384,104807,106746,113572,113578,115626,117468,122217,122747,131072,133164,134653,137444,142755,143691,144356,149091,155015,159381,163266,186684,190870,194766,200292,204303,208450,213787,215765,216169,224895,238030,259485,261390],[0.23617009366867722,1.5696318875736637,1.9739891727509844,3.0237438185897627,1.2086421758692076,3.0237438185897627,2.666664098284443,3.0237438185897627,2.404081945157195,3.0237438185897627,2.666664098284443,1.9739891727509844,10.521597807651608,2.024363018246058,3.0237438185897627,2.331271629618051,2.25014111224964,1.9516562688926788,2.331271629618051,3.0237438185897627,3.0237438185897627,1.281078203364926,3.0237438185897627,2.666664098284443,2.331271629618051,2.666664098284443,3.6680848167383187,3.0237438185897627,2.666664098284443,0.6702501205762497,2.666664098284443,2.404081945157195,5.333328196568886,3.0237438185897627,3.0237438185897627,2.331271629618051,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,2.666664098284443,2.404081945157195,3.0237438185897627,2.1985372578769105,3.0237438185897627,3.852063239982844,3.0237438185897627,2.331271629618051,2.1367582099353166,1.8340424083691593,0.9957045401138221,3.0237438185897627,1.6742170416550766])                                                                                                                                                                                                                                                                                                                 |
//    tfidf.show(false)

    val dataFrame = rate.zip(tfidf.rdd).map(tuple => new LabeledPoint(tuple._1.getAs[Int]("rate"), tuple._2.getAs[Vector]("features")))
      .toDF("label", "features")

    // +-----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    // |label|features                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
    // +-----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    // |5.0  |(262144,[3402,5224,11700,23411,24190,25171,29811,44436,47909,84318,85364,99516,115310,116958,117468,129826,158439,163110,175101,182711,188230,191490,200082,219629,227525,238030,248087,248533],[1.9739891727509844,0.47234018733735444,3.0237438185897627,1.9739891727509844,3.0237438185897627,1.9739891727509844,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,0.9758281344463394,5.333328196568886,3.0237438185897627,5.333328196568886,0.6702501205762497,3.0237438185897627,2.666664098284443,2.666664098284443,3.0237438185897627,3.0237438185897627,2.1367582099353166,2.6008869677697293,3.0237438185897627,1.4732281990790177,3.0237438185897627,0.39828181604552887,3.0237438185897627,3.0237438185897627])     |
    // |5.0  |(262144,[5224,7764,8306,18369,26081,28500,34967,36657,37868,44403,47672,63487,64028,64720,66345,75379,80738,85364,92269,94244,95360,95913,101791,102384,104807,106746,113572,113578,115626,117468,122217,122747,131072,133164,134653,137444,142755,143691,144356,149091,155015,159381,163266,186684,190870,194766,200292,204303,208450,213787,215765,216169,224895,238030,259485,261390],[0.23617009366867722,1.5696318875736637,1.9739891727509844,3.0237438185897627,1.2086421758692076,3.0237438185897627,2.666664098284443,3.0237438185897627,2.404081945157195,3.0237438185897627,2.666664098284443,1.9739891727509844,10.521597807651608,2.024363018246058,3.0237438185897627,2.331271629618051,2.25014111224964,1.9516562688926788,2.331271629618051,3.0237438185897627,3.0237438185897627,1.281078203364926,3.0237438185897627,2.666664098284443,2.331271629618051,2.666664098284443,3.6680848167383187,3.0237438185897627,2.666664098284443,0.6702501205762497,2.666664098284443,2.404081945157195,5.333328196568886,3.0237438185897627,3.0237438185897627,2.331271629618051,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,2.666664098284443,2.404081945157195,3.0237438185897627,2.1985372578769105,3.0237438185897627,3.852063239982844,3.0237438185897627,2.331271629618051,2.1367582099353166,1.8340424083691593,0.9957045401138221,3.0237438185897627,1.6742170416550766])                                                                                                                                                                                                                                                                                                                 |
    // |5.0  |(262144,[5936,8784,11415,13148,16401,23882,26081,27413,31931,38331,41567,49163,52445,53223,63487,75379,80738,83073,85364,90599,92797,93429,95913,103524,104957,110030,113572,117468,120093,126165,129980,133148,137444,143844,157118,160084,163216,166385,171020,172079,172954,185413,188230,188777,196702,196837,197020,200292,200568,208026,213503,215765,220626,227357,229544,229703,234199,236972,237124,238030,239900,240924,245922,261390],[3.0237438185897627,2.666664098284443,3.0237438185897627,3.0237438185897627,3.0237438185897627,2.666664098284443,2.4172843517384153,2.331271629618051,3.0237438185897627,2.666664098284443,3.0237438185897627,3.0237438185897627,2.331271629618051,2.666664098284443,1.9739891727509844,2.331271629618051,0.7500470374165467,3.0237438185897627,2.602208358523572,3.0237438185897627,3.0237438185897627,3.0237438185897627,1.281078203364926,2.666664098284443,3.0237438185897627,3.0237438185897627,1.8340424083691593,0.6702501205762497,2.666664098284443,3.0237438185897627,3.2039718468900547,2.666664098284443,2.331271629618051,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,2.666664098284443,1.8340424083691593,3.0237438185897627,2.1367582099353166,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,1.0992686289384552,3.0237438185897627,3.0237438185897627,3.0237438185897627,2.331271629618051,2.666664098284443,3.0237438185897627,3.0237438185897627,3.0237438185897627,3.0237438185897627,13.328601283898685,3.0237438185897627,0.39828181604552887,3.0237438185897627,1.8049023457275561,3.0237438185897627,1.6742170416550766])                                                                                            |
//    dataFrame.show(false)

    // 生成训练集和测试集
    val Array(trainingData, testData) = dataFrame.randomSplit(Array(0.7, 0.3), seed = 1234L)

    // +-----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    // |label|features                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
    // +-----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    // |3.0  |(262144,[5224,21916,29481,33773,85364,91015,105739,117468,136701,201923,219629,224895,238030,254099],[0.23617009366867722,3.174974788313686,3.866553341101005,3.174974788313686,0.650552089630893,2.7700331034051193,2.404081945157195,0.6702501205762497,3.866553341101005,3.866553341101005,1.4732281990790177,1.8340424083691593,0.19914090802276443,3.174974788313686])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
    // |5.0  |(262144,[5224,8775,11013,52445,62019,79549,80738,85364,87390,104807,106404,123890,126142,138926,152194,152599,160657,200054,200292,219110,233881,236922,238030,245911,258048],[0.7085102810060316,1.9739891727509844,3.0237438185897627,2.331271629618051,2.331271629618051,3.0237438185897627,0.7500470374165467,0.650552089630893,2.666664098284443,2.331271629618051,2.331271629618051,3.0237438185897627,2.6008869677697293,3.0237438185897627,2.666664098284443,3.0237438185897627,3.0237438185897627,3.0237438185897627,1.0992686289384552,3.0237438185897627,3.0237438185897627,1.9739891727509844,0.39828181604552887,3.0237438185897627,3.8810886927259736])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

//    trainingData.distinct().show(false)
    // +-----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    // |label|features                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
    // +-----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    // |3.0  |(262144,[5224,21916,29481,33773,85364,91015,105739,117468,136701,201923,219629,224895,238030,254099],[0.23617009366867722,3.174974788313686,3.866553341101005,3.174974788313686,0.650552089630893,2.7700331034051193,2.404081945157195,0.6702501205762497,3.866553341101005,3.866553341101005,1.4732281990790177,1.8340424083691593,0.19914090802276443,3.174974788313686])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
    // |5.0  |(262144,[5224,8775,11013,52445,62019,79549,80738,85364,87390,104807,106404,123890,126142,138926,152194,152599,160657,200054,200292,219110,233881,236922,238030,245911,258048],[0.7085102810060316,1.9739891727509844,3.0237438185897627,2.331271629618051,2.331271629618051,3.0237438185897627,0.7500470374165467,0.650552089630893,2.666664098284443,2.331271629618051,2.331271629618051,3.0237438185897627,2.6008869677697293,3.0237438185897627,2.666664098284443,3.0237438185897627,3.0237438185897627,3.0237438185897627,1.0992686289384552,3.0237438185897627,3.0237438185897627,1.9739891727509844,0.39828181604552887,3.0237438185897627,3.8810886927259736])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

//    testData.distinct().show(false)
    // Train a NaiveBayes iDFModel.
    val bayesModel = new NaiveBayes().fit(trainingData.distinct())

    //保存到硬盘
    bayesModel.write.overwrite().save("hdfs://192.168.1.200:9000/bayesModel")
    // Select example rows to display.
    val predictions = bayesModel.transform(testData.distinct())

    // +-----+------------------------------------------+----------+
    // |label|probability                               |prediction|
    // +-----+------------------------------------------+----------+
    // |0.0  |[1.0,2.111733848349619E-167]              |0.0       |
    // |0.0  |[1.0,1.3815567265349225E-46]              |0.0       |
    // |0.0  |[1.0,2.4920922472513825E-131]             |0.0       |
    // |1.0  |[2.4517917055179403E-67,1.0]              |1.0       |

//    predictions.select($"label", $"probability", $"prediction").show(false)

    // Select (prediction, true label) and compute test error
    val evaluator = new MulticlassClassificationEvaluator()
      .setLabelCol("label")
      .setPredictionCol("prediction")
      .setMetricName("accuracy")
    val accuracy = evaluator.evaluate(predictions)
    println(s"Test set accuracy = $accuracy")

    val myComment = sparkSession.createDataFrame(Seq((1,"这部电影没有意思，剧情老套，真没劲, 后悔来看了"),
      (2,"太精彩了讲了一个关于梦想的故事剧情很反转制作也很精良"),
      (3,"赞到惊人，大迪斯尼动画一年比一年精彩！朱迪只身去陌生的大城市追梦，让我又追忆起自己那美好而充实的留学生活了。们的每次出场自己都要笑到面瘫了！而朱迪跟尼克哭着道歉的那段我也跟着哭了，朋友之间有时候就应该这样把脸拉下来好好道歉！总体反映的各种社会现象以及政治问题都很贴切到位。")))
      .toDF("id", "comment")
    val frame = myComment.mapPartitions(it =>{
      val segmenter = new JiebaSegmenter()
      val stopWordsStr = broadStop.value
      it.map(comt => {
        val array = segmenter.process(comt.getAs[String]("comment"), SegMode.SEARCH).toArray.map(comment => {
          comment.asInstanceOf[SegToken].word
        }).filter(stopWordsStr.indexOf(_) < 0)
        array
      })
    }).toDF("word")
    val myTF = hashingTF.transform(frame)

    val myTFIDF = iDFModel.transform(myTF)

    bayesModel.transform(myTFIDF).show(false)

    tf.unpersist()
    sparkSession.stop()
  }

}
